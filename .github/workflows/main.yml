name: ci
run-name: Build Job
on: [push]
env:
  IMAGE_NAME: hello-world
jobs:
  npm-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '16'
      - run: npm ci
      - run: npm run build --if-present
      - run: npm test
  docker:
    runs-on: ubuntu-latest
    steps:
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
#       - name: Install the Jfrog Cli
#         uses: jfrog/setup-jfrog-cli@v3

#       - name: Authenticating to Jfrog
#         uses: jfrog/setup-jfrog-cli@v3
#         env:
#          JF_URL: https://bcapp.jfrog.io
#          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
       
      - name: Login to Jfrog Artifactory
        uses: docker/login-action@v2
        with:
          registry: bcapp.jfrog.io
          username: ${{ secrets.JF_USERNAME }}
          password: ${{ secrets.JF_PASSWORD }}
          
      - name: Build and push
        uses: docker/build-push-action@v3
        with:
          push: true
          tags: bcapp.jfrog.io/foundations-app-docker-local/${{ env.IMAGE_NAME }}:latest
      
#       - run: jf docker push bcapp.jfrog.io/foundations-app-docker-local/${{ env.IMAGE_NAME }}:latest
         
 
  deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Installing Kubectl 
        uses: azure/setup-kubectl@v2.0
        with:
          version: v1.24.6
        id: install
        
      - name: Set the kube context
        uses: azure/k8s-set-context@v1
        with:
          method: kubeconfig
          kubeconfig: ${{secrets.KUBE_CONFIG}}
          context: foundation-production-admin
        id: setcontext
        
      - name: Creating image pull secret
        uses: Azure/k8s-create-secret@v1.1
        with:
          container-registry-url: sivaeastus.azurecr.io
          container-registry-username: ${{ secrets.AZURE_CLIENT_ID }}
          container-registry-password: ${{ secrets.AZURE_CLIENT_SECRET }}
          secret-name: image-pull-secret
        
